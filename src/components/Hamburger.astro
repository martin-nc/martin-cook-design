---
import Navigation from "./Navigation.astro";
---

<button
  id="hamburgerMenu"
  class="navButton"
  aria-label="Open main menu"
  aria-expanded="false"
  aria-controls="primaryNav"
>
  <span class="sr-only">Menu</span>
  <!-- simple icon -->
  <svg
    width="24"
    height="24"
    viewBox="0 0 24 24"
    aria-hidden="true"
    focusable="false"
  >
    <rect y="5" width="24" height="2" rx="1"></rect>
    <rect y="11" width="24" height="2" rx="1"></rect>
    <rect y="17" width="24" height="2" rx="1"></rect>
  </svg>
</button>

<nav id="primaryNav" class="mobileNav" hidden aria-hidden="true">
  <Navigation />
</nav>

<style>
  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0 0 0 0);
    white-space: nowrap;
    border: 0;
  }

  .navButton {
    background: transparent;
    border: none;
    padding: 8px;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
  }

  .mobileNav[hidden] {
    display: none;
  }

  .mobileNav {
    position: absolute;
    top: 100%;
    right: 0;
    background: var(--menu-bg, #fff);
    border: 1px solid rgba(0, 0, 0, 0.1);
    padding: 1rem;
    z-index: 1000;
    min-width: 200px;
    box-shadow: 0 6px 18px rgba(0, 0, 0, 0.1);
  }
</style>

<script type="module">
  const btn = document.getElementById("hamburgerMenu");
  const nav = document.getElementById("primaryNav");

  if (btn && nav) {
    const focusableSelector =
      'a[href], button, input, select, textarea, [tabindex]:not([tabindex="-1"])';
    let focusable = [];
    let firstFocusable = null;
    let lastFocusable = null;

    function updateFocusables() {
      focusable = Array.from(nav.querySelectorAll(focusableSelector)).filter(
        (el) => !el.hasAttribute("disabled") && el.offsetParent !== null
      );
      firstFocusable = focusable[0] || nav;
      lastFocusable = focusable[focusable.length - 1] || nav;
    }

    function openMenu() {
      btn.setAttribute("aria-expanded", "true");
      nav.removeAttribute("hidden");
      nav.setAttribute("aria-hidden", "false");
      document.body.style.overflow = "hidden";
      updateFocusables();
      (firstFocusable || nav).focus();
      document.addEventListener("keydown", handleKeydown);
    }

    function closeMenu() {
      btn.setAttribute("aria-expanded", "false");
      nav.setAttribute("hidden", "");
      nav.setAttribute("aria-hidden", "true");
      document.body.style.overflow = "";
      btn.focus();
      document.removeEventListener("keydown", handleKeydown);
    }

    function toggleMenu() {
      const open = btn.getAttribute("aria-expanded") === "true";
      if (open) closeMenu();
      else openMenu();
    }

    function handleKeydown(e) {
      if (e.key === "Escape") {
        e.preventDefault();
        closeMenu();
        return;
      }

      if (e.key === "Tab") {
        updateFocusables();
        if (focusable.length === 0) {
          // keep focus inside nav
          e.preventDefault();
          return;
        }

        if (e.shiftKey) {
          if (document.activeElement === firstFocusable) {
            e.preventDefault();
            lastFocusable.focus();
          }
        } else {
          if (document.activeElement === lastFocusable) {
            e.preventDefault();
            firstFocusable.focus();
          }
        }
      }
    }

    btn.addEventListener("click", toggleMenu);

    // Close when clicking outside the nav
    document.addEventListener("click", (e) => {
      if (btn.getAttribute("aria-expanded") === "true") {
        if (!nav.contains(e.target) && !btn.contains(e.target)) {
          closeMenu();
        }
      }
    });

    // Ensure menu is closed if JS is reloaded / SSR mismatch
    // (keeps aria and hidden in sync)
    if (
      btn.getAttribute("aria-expanded") === "true" &&
      nav.hasAttribute("hidden")
    ) {
      btn.setAttribute("aria-expanded", "false");
    }
  }
</script>
